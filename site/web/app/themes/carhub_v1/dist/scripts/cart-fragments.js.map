{"version":3,"sources":["../assets/scripts/cart-fragments.js"],"names":["jQuery","$","set_cart_creation_timestamp","$supports_html5_storage","sessionStorage","setItem","Date","getTime","set_cart_hash","cart_hash","localStorage","cart_hash_key","refresh_cart_fragment","ajax","$fragment_refresh","wc_cart_fragments_params","ajax_url","toString","window","removeItem","err","url","wc_ajax_url","replace","type","success","data","fragments","each","key","value","replaceWith","fragment_name","JSON","stringify","document","body","trigger","cart_timeout","on","event","prev_cart_hash","getItem","undefined","clearTimeout","setTimeout","e","originalEvent","persisted","empty","wc_fragments","parseJSON","cookie_hash","Cookies","get","cart_created","cart_expiration","timestamp_now","closest","show","hide"],"mappings":"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","file":"cart-fragments.js","sourcesContent":["/* global wc_cart_fragments_params, Cookies */\njQuery( function( $ ) {\n\n\t// wc_cart_fragments_params is required to continue, ensure the object exists\n\tif ( typeof wc_cart_fragments_params === 'undefined' ) {\n\t\treturn false;\n\t}\n\n\t/* Storage Handling */\n\tvar $supports_html5_storage;\n\tvar cart_hash_key = wc_cart_fragments_params.ajax_url.toString() + '-wc_cart_hash';\n\n\ttry {\n\t\t$supports_html5_storage = ( 'sessionStorage' in window && window.sessionStorage !== null );\n\t\twindow.sessionStorage.setItem( 'wc', 'test' );\n\t\twindow.sessionStorage.removeItem( 'wc' );\n\t\twindow.localStorage.setItem( 'wc', 'test' );\n\t\twindow.localStorage.removeItem( 'wc' );\n\t} catch( err ) {\n\t\t$supports_html5_storage = false;\n\t}\n\n\t/* Cart session creation time to base expiration on */\n\tfunction set_cart_creation_timestamp() {\n\t\tif ( $supports_html5_storage ) {\n\t\t\tsessionStorage.setItem( 'wc_cart_created', ( new Date() ).getTime() );\n\t\t}\n\t}\n\n\t/** Set the cart hash in both session and local storage */\n\tfunction set_cart_hash( cart_hash ) {\n\t\tif ( $supports_html5_storage ) {\n\t\t\tlocalStorage.setItem( cart_hash_key, cart_hash );\n\t\t\tsessionStorage.setItem( cart_hash_key, cart_hash );\n\t\t}\n\t}\n\n\tvar $fragment_refresh = {\n\t\turl: wc_cart_fragments_params.wc_ajax_url.toString().replace( '%%endpoint%%', 'get_refreshed_fragments' ),\n\t\ttype: 'POST',\n\t\tsuccess: function( data ) {\n\t\t\tif ( data && data.fragments ) {\n\n\t\t\t\t$.each( data.fragments, function( key, value ) {\n\t\t\t\t\t$( key ).replaceWith( value );\n\t\t\t\t});\n\n\t\t\t\tif ( $supports_html5_storage ) {\n\t\t\t\t\tsessionStorage.setItem( wc_cart_fragments_params.fragment_name, JSON.stringify( data.fragments ) );\n\t\t\t\t\tset_cart_hash( data.cart_hash );\n\n\t\t\t\t\tif ( data.cart_hash ) {\n\t\t\t\t\t\tset_cart_creation_timestamp();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t$( document.body ).trigger( 'wc_fragments_refreshed' );\n\t\t\t}\n\t\t}\n\t};\n\n\t/* Named callback for refreshing cart fragment */\n\tfunction refresh_cart_fragment() {\n\t\t$.ajax( $fragment_refresh );\n\t}\n\n\t/* Cart Handling */\n\tif ( $supports_html5_storage ) {\n\n\t\tvar cart_timeout = null,\n\t\t\tday_in_ms    = ( 24 * 60 * 60 * 1000 );\n\n\t\t$( document.body ).on( 'wc_fragment_refresh updated_wc_div', function() {\n\t\t\trefresh_cart_fragment();\n\t\t});\n\n\t\t$( document.body ).on( 'added_to_cart', function( event, fragments, cart_hash ) {\n\t\t\tvar prev_cart_hash = sessionStorage.getItem( cart_hash_key );\n\n\t\t\tif ( prev_cart_hash === null || prev_cart_hash === undefined || prev_cart_hash === '' ) {\n\t\t\t\tset_cart_creation_timestamp();\n\t\t\t}\n\n\t\t\tsessionStorage.setItem( wc_cart_fragments_params.fragment_name, JSON.stringify( fragments ) );\n\t\t\tset_cart_hash( cart_hash );\n\t\t});\n\n\t\t$( document.body ).on( 'wc_fragments_refreshed', function() {\n\t\t\tclearTimeout( cart_timeout );\n\t\t\tcart_timeout = setTimeout( refresh_cart_fragment, day_in_ms );\n\t\t} );\n\n\t\t// Refresh when storage changes in another tab\n\t\t$( window ).on( 'storage onstorage', function ( e ) {\n\t\t\tif ( cart_hash_key === e.originalEvent.key && localStorage.getItem( cart_hash_key ) !== sessionStorage.getItem( cart_hash_key ) ) {\n\t\t\t\trefresh_cart_fragment();\n\t\t\t}\n\t\t});\n\n\t\t// Refresh when page is shown after back button (safari)\n\t\t$( window ).on( 'pageshow' , function( e ) {\n\t\t\tif ( e.originalEvent.persisted ) {\n\t\t\t\t$( '.widget_shopping_cart_content' ).empty();\n\t\t\t\t$( document.body ).trigger( 'wc_fragment_refresh' );\n\t\t\t}\n\t\t} );\n\n\t\ttry {\n\t\t\tvar wc_fragments = $.parseJSON( sessionStorage.getItem( wc_cart_fragments_params.fragment_name ) ),\n\t\t\t\tcart_hash    = sessionStorage.getItem( cart_hash_key ),\n\t\t\t\tcookie_hash  = Cookies.get( 'woocommerce_cart_hash'),\n\t\t\t\tcart_created = sessionStorage.getItem( 'wc_cart_created' );\n\n\t\t\tif ( cart_hash === null || cart_hash === undefined || cart_hash === '' ) {\n\t\t\t\tcart_hash = '';\n\t\t\t}\n\n\t\t\tif ( cookie_hash === null || cookie_hash === undefined || cookie_hash === '' ) {\n\t\t\t\tcookie_hash = '';\n\t\t\t}\n\n\t\t\tif ( cart_hash && ( cart_created === null || cart_created === undefined || cart_created === '' ) ) {\n\t\t\t\tthrow 'No cart_created';\n\t\t\t}\n\n\t\t\tif ( cart_created ) {\n\t\t\t\tvar cart_expiration = ( ( 1 * cart_created ) + day_in_ms ),\n\t\t\t\t\ttimestamp_now   = ( new Date() ).getTime();\n\t\t\t\tif ( cart_expiration < timestamp_now ) {\n\t\t\t\t\tthrow 'Fragment expired';\n\t\t\t\t}\n\t\t\t\tcart_timeout = setTimeout( refresh_cart_fragment, ( cart_expiration - timestamp_now ) );\n\t\t\t}\n\n\t\t\tif ( wc_fragments && wc_fragments['div.widget_shopping_cart_content'] && cart_hash === cookie_hash ) {\n\n\t\t\t\t$.each( wc_fragments, function( key, value ) {\n\t\t\t\t\t$( key ).replaceWith(value);\n\t\t\t\t});\n\n\t\t\t\t$( document.body ).trigger( 'wc_fragments_loaded' );\n\t\t\t} else {\n\t\t\t\tthrow 'No fragment';\n\t\t\t}\n\n\t\t} catch( err ) {\n\t\t\trefresh_cart_fragment();\n\t\t}\n\n\t} else {\n\t\trefresh_cart_fragment();\n\t}\n\n\t/* Cart Hiding */\n\tif ( Cookies.get( 'woocommerce_items_in_cart' ) > 0 ) {\n\t\t$( '.hide_cart_widget_if_empty' ).closest( '.widget_shopping_cart' ).show();\n\t} else {\n\t\t$( '.hide_cart_widget_if_empty' ).closest( '.widget_shopping_cart' ).hide();\n\t}\n\n\t$( document.body ).on( 'adding_to_cart', function() {\n\t\t$( '.hide_cart_widget_if_empty' ).closest( '.widget_shopping_cart' ).show();\n\t});\n});\n"],"sourceRoot":"assets/scripts/"}